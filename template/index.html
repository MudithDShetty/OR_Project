<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuhn Poker GTO Solver</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(15, 76, 117, 0.3);
            border-radius: 15px;
            border: 2px solid #0f4c75;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #4CAF50;
        }

        .game-value {
            font-size: 1.5em;
            color: #2196F3;
            margin: 10px 0;
        }

        .section {
            background: rgba(22, 33, 62, 0.8);
            margin: 30px 0;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #0f4c75;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .section h2 {
            color: #4CAF50;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .section h3 {
            color: #2196F3;
            margin: 20px 0 10px 0;
            font-size: 1.3em;
        }

        .button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px 5px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .button.danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .button.warning {
            background: linear-gradient(45deg, #FF9800, #f57c00);
        }

        .button.info {
            background: linear-gradient(45deg, #2196F3, #1976d2);
        }

        .button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #cccccc;
            font-weight: bold;
        }

        .input-group input, .input-group select {
            width: 100%;
            max-width: 300px;
            padding: 10px;
            border: 2px solid #0f4c75;
            border-radius: 8px;
            background: #1a1a2e;
            color: #ffffff;
            font-size: 16px;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .progress-container {
            background: #1a1a2e;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
            border: 2px solid #0f4c75;
        }

        .progress-bar {
            height: 30px;
            background: linear-gradient(45deg, #4CAF50, #2196F3);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .strategy-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(26, 26, 46, 0.8);
            border-radius: 10px;
            overflow: hidden;
        }

        .strategy-table th,
        .strategy-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #0f4c75;
        }

        .strategy-table th {
            background: #0f4c75;
            color: #4CAF50;
            font-weight: bold;
        }

        .strategy-table tr:hover {
            background: rgba(15, 76, 117, 0.2);
        }

        .card-display {
            display: inline-block;
            background: #ffffff;
            color: #000000;
            padding: 20px;
            border-radius: 10px;
            margin: 10px;
            font-size: 1.5em;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .game-controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .status-display {
            background: rgba(15, 76, 117, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #4CAF50;
        }

        .status-display.error {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .status-display.success {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .game-log {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #0f4c75;
        }

        .game-log div {
            margin: 5px 0;
            padding: 5px;
            background: rgba(15, 76, 117, 0.2);
            border-radius: 5px;
        }

        .advice-panel {
            background: rgba(33, 150, 243, 0.1);
            border: 2px solid #2196F3;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .game-controls {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .card-jack { background: #FFE0B2; color: #E65100; }
        .card-queen { background: #F3E5F5; color: #4A148C; }
        .card-king { background: #E8F5E8; color: #2E7D32; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üéØ Kuhn Poker GTO Solver</h1>
            <p>Game Theory Optimal Analysis using CFR & Linear Programming</p>
            <div class="game-value">Optimal Game Value: -0.05555556 (exactly -1/18)</div>
        </div>

        <!-- Linear Programming Solution -->
        <div class="section">
            <h2>üìä Linear Programming GTO Solution</h2>
            <p>Mathematically proven optimal strategies:</p>
            
            <div class="comparison-grid">
                <div>
                    <h3>Player 1 (First to Act)</h3>
                    <table class="strategy-table" id="lp-p1-table">
                        <thead>
                            <tr>
                                <th>Card</th>
                                <th>Initial Bet %</th>
                                <th>Call Check-Bet %</th>
                                <th>Strategy</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>üÉã Jack</td>
                                <td>11.11%</td>
                                <td>0.00%</td>
                                <td>Light bluff, never call</td>
                            </tr>
                            <tr>
                                <td>üÉç Queen</td>
                                <td>0.00%</td>
                                <td>44.44%</td>
                                <td>Never bet, sometimes call</td>
                            </tr>
                            <tr>
                                <td>üÉé King</td>
                                <td>33.33%</td>
                                <td>66.67%</td>
                                <td>Mixed betting, value calls</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div>
                    <h3>Player 2 (Responds)</h3>
                    <table class="strategy-table" id="lp-p2-table">
                        <thead>
                            <tr>
                                <th>Card</th>
                                <th>Call Bet %</th>
                                <th>Bet When Checked %</th>
                                <th>Strategy</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>üÉã Jack</td>
                                <td>0.00%</td>
                                <td>33.33%</td>
                                <td>Never call, sometimes bluff</td>
                            </tr>
                            <tr>
                                <td>üÉç Queen</td>
                                <td>33.33%</td>
                                <td>0.00%</td>
                                <td>Light calls, never bet</td>
                            </tr>
                            <tr>
                                <td>üÉé King</td>
                                <td>100.00%</td>
                                <td>100.00%</td>
                                <td>Always aggressive</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CFR Training -->
        <div class="section">
            <h2>üé≤ CFR Training (Counterfactual Regret Minimization)</h2>
            <p>Train an AI to learn optimal strategies through self-play:</p>
            
            <div class="input-group">
                <label for="iterations">Training Iterations:</label>
                <input type="number" id="iterations" value="10000" min="1000" max="1000000" step="1000">
            </div>
            
            <div class="game-controls">
                <button class="button" id="start-training" onclick="startTraining()">
                    üöÄ Start CFR Training
                </button>
                <button class="button danger" id="stop-training" onclick="stopTraining()" disabled>
                    ‚èπÔ∏è Stop Training
                </button>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="training-progress">0%</div>
            </div>
            
            <div class="status-display" id="training-status">
                Ready to train CFR model. Click "Start CFR Training" to begin.
            </div>
            
            <h3>Current CFR Strategies</h3>
            <div class="comparison-grid">
                <div>
                    <h4>Player 1 CFR Strategies</h4>
                    <table class="strategy-table" id="cfr-p1-table">
                        <thead>
                            <tr>
                                <th>Card</th>
                                <th>Check %</th>
                                <th>Bet %</th>
                            </tr>
                        </thead>
                        <tbody id="cfr-p1-body">
                            <tr><td>üÉã Jack</td><td>50.0%</td><td>50.0%</td></tr>
                            <tr><td>üÉç Queen</td><td>50.0%</td><td>50.0%</td></tr>
                            <tr><td>üÉé King</td><td>50.0%</td><td>50.0%</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div>
                    <h4>Current Game Value</h4>
                    <div class="status-display">
                        <strong>CFR Game Value: <span id="cfr-game-value">0.000000</span></strong><br>
                        <strong>Optimal Value: -0.055556</strong><br>
                        <strong>Difference: <span id="convergence-diff">Unknown</span></strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interactive Game -->
        <div class="section">
            <h2>üéÆ Play Against Trained AI</h2>
            <p>Test your skills against the CFR-trained AI:</p>
            
            <div class="game-controls">
                <button class="button info" onclick="startNewGame()">üÜï Start New Game</button>
                <button class="button" id="check-btn" onclick="playerAction('p')" disabled>‚úã Check/Pass</button>
                <button class="button danger" id="bet-btn" onclick="playerAction('b')" disabled>üí∞ Bet/Call</button>
            </div>
            
            <div class="status-display" id="game-status">
                Click "Start New Game" to begin playing!
            </div>
            
            <div id="game-area" class="hidden">
                <h3>Current Game</h3>
                <div>
                    <strong>Your Card:</strong> <span class="card-display" id="player-card">?</span>
                    <strong>AI Card:</strong> <span class="card-display" id="ai-card">üé¥</span>
                </div>
                
                <div>
                    <strong>Pot:</strong> $<span id="pot-value">2</span>
                    <strong>Bankroll:</strong> $<span id="bankroll">0</span>
                </div>
                
                <div class="game-log" id="game-log"></div>
            </div>
        </div>

        <!-- Strategy Advisor -->
        <div class="section">
            <h2>ü§ñ GTO Strategy Advisor</h2>
            <p>Get optimal strategy advice for any situation:</p>
            
            <div class="comparison-grid">
                <div>
                    <div class="input-group">
                        <label for="advice-player">Player:</label>
                        <select id="advice-player">
                            <option value="1">Player 1 (First to Act)</option>
                            <option value="2">Player 2 (Responds)</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="advice-card">Card:</label>
                        <select id="advice-card">
                            <option value="1">üÉã Jack</option>
                            <option value="2">üÉç Queen</option>
                            <option value="3">üÉé King</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="advice-situation">Situation:</label>
                        <select id="advice-situation">
                            <option value="initial">Initial Action</option>
                            <option value="check_bet">Response to Check-Bet</option>
                            <option value="vs_bet">Response to Bet</option>
                            <option value="checked_to">Action When Checked To</option>
                        </select>
                    </div>
                    
                    <button class="button info" onclick="getAdvice()">üéØ Get GTO Advice</button>
                </div>
                
                <div class="advice-panel" id="advice-display">
                    <h4>GTO Recommendations</h4>
                    <p>Select player, card, and situation, then click "Get GTO Advice" to see optimal play.</p>
                </div>
            </div>
        </div>

        <!-- Comparison Analysis -->
        <div class="section">
            <h2>üìà CFR vs Linear Programming Comparison</h2>
            <p>Compare how CFR training approaches the mathematically optimal solution:</p>
            
            <div class="status-display" id="comparison-status">
                <strong>Convergence Analysis:</strong><br>
                CFR learns through experience while LP provides exact mathematical solution.<br>
                Watch how CFR strategies converge to optimal play through training.
            </div>
            
            <div class="comparison-grid">
                <div>
                    <h4>Training Progress</h4>
                    <div>
                        <strong>CFR Iterations:</strong> <span id="total-iterations">0</span><br>
                        <strong>Current Game Value:</strong> <span id="current-value">0.000000</span><br>
                        <strong>Optimal Game Value:</strong> -0.055556<br>
                        <strong>Convergence Quality:</strong> <span id="convergence-quality">Not Started</span>
                    </div>
                </div>
                
                <div>
                    <h4>Key Insights</h4>
                    <div>
                        ‚Ä¢ CFR discovers optimal strategies through trial and error<br>
                        ‚Ä¢ Linear Programming provides exact mathematical solution<br>
                        ‚Ä¢ Both approaches converge to the same Nash equilibrium<br>
                        ‚Ä¢ Game value should approach -0.055556 with more training
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let trainingActive = false;
        let currentGame = null;

        // API calls
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`/api/${endpoint}`, options);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Unknown error');
                }
                
                return result;
            } catch (error) {
                console.error(`API call to ${endpoint} failed:`, error);
                showStatus('error', `Error: ${error.message}`);
                throw error;
            }
        }

        // Training functions
        async function startTraining() {
            const iterations = parseInt(document.getElementById('iterations').value);
            
            if (trainingActive) {
                showStatus('error', 'Training is already in progress!');
                return;
            }
            
            trainingActive = true;
            document.getElementById('start-training').disabled = true;
            document.getElementById('stop-training').disabled = false;
            
            showStatus('success', `Starting CFR training for ${iterations.toLocaleString()} iterations...`);
            updateProgress(0, 'Starting training...');
            
            try {
                const result = await apiCall('start_training', 'POST', { iterations });
                
                showStatus('success', `Training completed! Game value: ${result.game_value.toFixed(6)}`);
                updateProgress(100, 'Training complete!');
                updateCFRStrategies(result.strategies, result.game_value);
                updateComparison(result.iterations, result.game_value);
                
            } catch (error) {
                showStatus('error', `Training failed: ${error.message}`);
                updateProgress(0, 'Training failed');
            } finally {
                trainingActive = false;
                document.getElementById('start-training').disabled = false;
                document.getElementById('stop-training').disabled = true;
            }
        }

        function stopTraining() {
            if (!trainingActive) return;
            
            trainingActive = false;
            document.getElementById('start-training').disabled = false;
            document.getElementById('stop-training').disabled = true;
            
            showStatus('warning', 'Training stopped by user');
            updateProgress(0, 'Training stopped');
        }

        // Game functions
        async function startNewGame() {
            try {
                showStatus('success', 'Starting new game...');
                
                const result = await apiCall('start_game', 'POST');
                
                currentGame = result;
                document.getElementById('game-area').classList.remove('hidden');
                document.getElementById('check-btn').disabled = false;
                document.getElementById('bet-btn').disabled = false;
                
                // Update display
                const cardNames = {1: 'üÉã Jack', 2: 'üÉç Queen', 3: 'üÉé King'};
                document.getElementById('player-card').textContent = cardNames[result.player_card];
                document.getElementById('player-card').className = `card-display card-${cardNames[result.player_card].toLowerCase().split(' ')[1]}`;
                document.getElementById('ai-card').textContent = 'üé¥';
                document.getElementById('pot-value').textContent = result.pot;
                document.getElementById('bankroll').textContent = result.bankroll || 0;
                
                showGameStatus('success', result.message);
                clearGameLog();
                
            } catch (error) {
                showStatus('error', `Failed to start game: ${error.message}`);
            }
        }

        async function playerAction(action) {
            if (!currentGame || currentGame.game_over) {
                showStatus('error', 'No active game. Start a new game first.');
                return;
            }
            
            try {
                const result = await apiCall('player_action', 'POST', { action });
                
                // Update game state
                currentGame = result;
                
                if (result.pot) {
                    document.getElementById('pot-value').textContent = result.pot;
                }
                
                if (result.bankroll !== undefined) {
                    document.getElementById('bankroll').textContent = result.bankroll;
                }
                
                if (result.log) {
                    result.log.forEach(entry => addToGameLog(entry));
                }
                
                if (result.game_over) {
                    document.getElementById('check-btn').disabled = true;
                    document.getElementById('bet-btn').disabled = true;
                    
                    // Show AI card
                    const cardNames = {1: 'üÉã Jack', 2: 'üÉç Queen', 3: 'üÉé King'};
                    document.getElementById('ai-card').textContent = cardNames[result.ai_card];
                    document.getElementById('ai-card').className = `card-display card-${cardNames[result.ai_card].toLowerCase().split(' ')[1]}`;
                    
                    showGameStatus(result.winnings > 0 ? 'success' : 'error', result.message);
                } else {
                    showGameStatus('success', result.message || 'Game continues...');
                }
                
            } catch (error) {
                showStatus('error', `Action failed: ${error.message}`);
            }
        }

        // Advice function
        async function getAdvice() {
            const player = parseInt(document.getElementById('advice-player').value);
            const card = parseInt(document.getElementById('advice-card').value);
            const situation = document.getElementById('advice-situation').value;
            
            try {
                const result = await apiCall('get_advice', 'POST', { player, card, situation });
                
                const adviceDisplay = document.getElementById('advice-display');
                adviceDisplay.innerHTML = `
                    <h4>GTO Recommendations for ${result.card_name}</h4>
                    <div style="margin: 15px 0;">
                        <strong>üìä Linear Programming (Exact):</strong><br>
                        <span style="color: #4CAF50; font-size: 1.2em;">${result.lp_advice}</span><br>
                        <em>${result.lp_reasoning}</em>
                    </div>
                    <div style="margin: 15px 0;">
                        <strong>üé≤ CFR Training (Learned):</strong><br>
                        <span style="color: #2196F3; font-size: 1.2em;">${result.cfr_advice}</span><br>
                        <em>Based on current training progress</em>
                    </div>
                `;
                
            } catch (error) {
                showStatus('error', `Failed to get advice: ${error.message}`);
            }
        }

        // Update functions
        function updateProgress(percentage, message) {
            const progressBar = document.getElementById('training-progress');
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = message;
        }

        function updateCFRStrategies(strategies, gameValue) {
            // Update CFR strategy table
            const tbody = document.getElementById('cfr-p1-body');
            
            if (strategies && Object.keys(strategies).length > 0) {
                tbody.innerHTML = `
                    <tr>
                        <td>üÉã Jack</td>
                        <td>${((strategies.Jack_initial?.check_prob || 0.5) * 100).toFixed(1)}%</td>
                        <td>${((strategies.Jack_initial?.bet_prob || 0.5) * 100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td>üÉç Queen</td>
                        <td>${((strategies.Queen_initial?.check_prob || 0.5) * 100).toFixed(1)}%</td>
                        <td>${((strategies.Queen_initial?.bet_prob || 0.5) * 100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td>üÉé King</td>
                        <td>${((strategies.King_initial?.check_prob || 0.5) * 100).toFixed(1)}%</td>
                        <td>${((strategies.King_initial?.bet_prob || 0.5) * 100).toFixed(1)}%</td>
                    </tr>
                `;
            }
            
            // Update game value display
            document.getElementById('cfr-game-value').textContent = gameValue.toFixed(6);
            
            const optimal = -0.055556;
            const diff = Math.abs(gameValue - optimal);
            document.getElementById('convergence-diff').textContent = diff.toFixed(6);
        }

        function updateComparison(iterations, gameValue) {
            document.getElementById('total-iterations').textContent = iterations.toLocaleString();
            document.getElementById('current-value').textContent = gameValue.toFixed(6);
            
            const optimal = -0.055556;
            const diff = Math.abs(gameValue - optimal);
            
            let quality = 'Poor';
            if (diff < 0.001) quality = 'Excellent';
            else if (diff < 0.01) quality = 'Good';
            else if (diff < 0.05) quality = 'Fair';
            
            document.getElementById('convergence-quality').textContent = `${quality} (${diff.toFixed(6)} difference)`;
        }

        function showStatus(type, message) {
            const status = document.getElementById('training-status');
            status.className = `status-display ${type}`;
            status.textContent = message;
        }

        function showGameStatus(type, message) {
            const status = document.getElementById('game-status');
            status.className = `status-display ${type}`;
            status.textContent = message;
        }

        function addToGameLog(entry) {
            const log = document.getElementById('game-log');
            const div = document.createElement('div');
            div.textContent = entry;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function clearGameLog() {
            document.getElementById('game-log').innerHTML = '';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('success', 'Kuhn Poker GTO Solver ready! Start with CFR training or play a game.');
        });
    </script>
</body>
</html>